---
title: "Estimations effets"
author: "Abel AUSSANT"
date: "17/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)

library(tidyverse)
library(here)
library(lmtest)
library(sandwich)
library(gt)
library(gtsummary)
library(boot)


source(here("02_import", "import_bases.R"))

source(here("03_scripts", "matching_final.R"))

theme_gtsummary_language("fr", decimal.mark = ",", big.mark = " ")

PC18_to_m_survey <- survey::svydesign(id = ~IDENT18, data = PC18_to_m, weights = PC18_to_m$POND)

PC18_m_survey <- survey::svydesign(id = ~IDENT18, data = PC18_m, weights = PC18_m$POND_m)

```
 Ce document consiste en une compilation d'estimation d'effet en mobilisant systématiquement une comparaison avant/après matching.
 
# Effet sur la diversité des gouts

## Différence de moyennes simple

L'estimation la plus simple pour estimer l'effet du streaming sur la diversité des gout consiste en une comparaison de moyenne pour le nombre de styles musicaux écoutés entre groupe traité et groupe non traité.

```{r}

#Moyenne non matché
mean_bfm_nostrm <- weighted.mean(PC18_to_m$nbr_genre_music[PC18_to_m$stream_spe == 0], 
                                 PC18_to_m$POND[PC18_to_m$stream_spe == 0])
mean_bfm_strm <- weighted.mean(PC18_to_m$nbr_genre_music[PC18_to_m$stream_spe == 1], 
                               PC18_to_m$POND[PC18_to_m$stream_spe == 1])

# Moyenne matché, matching template
mean_afm_nostrm <- weighted.mean(PC18_m$nbr_genre_music[PC18_m$stream_spe == 0], 
                                 PC18_m$POND_m[PC18_m$stream_spe == 0])
mean_afm_strm <- weighted.mean(PC18_m$nbr_genre_music[PC18_m$stream_spe == 1], 
                               PC18_m$POND_m[PC18_m$stream_spe == 1])



means <- data.frame(non_streameur = c(mean_bfm_nostrm, mean_afm_nostrm), streameur = c(mean_bfm_strm, mean_afm_strm))
means <- mutate(means, across(everything(), round, 2))

rownames(means) <- c("Avant matching","Après matching template")

kableExtra::kable(means)
```

On constate une différence importante avant matching (plus de 1,2), mais très faible après matching (moins de 0,1). En revanche, dans l'échantillion matché avec la méthode cardinality, on retrouve un écart à 0.4 environ entre échantillion.

## Regression sans prise en compte des covariables

On peut procéder de la même manière avec une regression linéaire. 

**Avant matching**

```{r}
lm_nbr_genre_bfm <- lm(nbr_genre_music ~ stream_spe, PC18_to_m, weights = POND)

coeftest(lm_nbr_genre_bfm, vcov. = vcovHC)

```

**Après matching**

```{r}
lm_nbr_genre_afm <- lm(nbr_genre_music ~ stream_spe, PC18_m, weights = POND_m)

coeftest(lm_nbr_genre_afm, vcov. = vcovHC)


```

On trouve des résultats proches de ce qu'on pouvait observer en comparant les moyennes. Par ailleurs on voit que le variation dans l'echantillion matché n'est pas significative quand on utlise les erreurs standards robust à l'hétéroscedasticité.

## Regression avec covariables

### Sans interaction

Enfin, on peut utiliser les variables de contrôle utiliser pour le matching dans le modèle. Cela réduit encore davantage le biais.

**Avant matching**

```{r}
formula_nbr_genre <- as.formula(paste("nbr_genre_music ~ stream_spe + ", covar_formula))

lm_nbr_genre_bfm <- lm(formula_nbr_genre, PC18_to_m, weights = POND)

coeftest(lm_nbr_genre_bfm, vcov. = vcovHC)

summary(lm_nbr_genre_bfm)$adj.r.squared


```

**Après matching**

```{r}
lm_nbr_genre_afm <- lm(formula_nbr_genre, PC18_m, weights = POND_m)

coeftest(lm_nbr_genre_afm, vcov. = vcovHC)

summary(lm_nbr_genre_afm)$adj.r.squared

```

**Après matching cardinality**

```{r}
lm_nbr_genre_afmcard <- lm(formula_nbr_genre, PC18_m_card)

coeftest(lm_nbr_genre_afmcard, vcov. = vcovHC)

summary(lm_nbr_genre_afmcard)$adj.r.squared

```


### Avec interaction

Il peut être interessant d'ajouter des interaction dans les modèles ainsi obtenues.

Par ailleurs on peut penser que l'age n'a pas un effet linéaire dans notre cas, catégorisé peut être une solution pour observer un effet spécifique du streaming chez certaines tranche d'age.

```{r}
formula_nbr_genre <- as.formula("nbr_genre_music ~ stream_spe + SEXE_r + AGE_r + CRITREVENU_r + PCS_MENAGE + DIPLOME_r + 
                         naiss_parents + DIPLOME_pere + DIPLOME_mere + VITENCOUPLE_r + 
                         music_amateur + freq_tv + equip_tv + clip_tv + freq_film + 
                         film_stream_VOD + film_stream_autre + nbr_genre_film + equip_serie + 
                         serie_stream_VOD + serie_replay + info_internet + musee_art_12m + 
                         galerie_12m + freq_internet + reseaux_sociaux + culture_en_ligne + 
                         tv_enfance + audivisuel_nonFR + stream_spe:AGE_r")

lm_nbr_genre_bfm <- lm(formula_nbr_genre, PC18_to_m, weights = POND)

coeftest(lm_nbr_genre_bfm, vcov. = vcovHC)

summary(lm_nbr_genre_bfm)$adj.r.squared


```

**Après matching**

```{r}
lm_nbr_genre_afm <- lm(formula_nbr_genre, PC18_m, weights = POND_m)

coeftest(lm_nbr_genre_afm, vcov. = vcovHC)

summary(lm_nbr_genre_afm)$adj.r.squared

```

**Après matching cardinality**

```{r}
lm_nbr_genre_afmcard <- lm(formula_nbr_genre, PC18_m_card)

coeftest(lm_nbr_genre_afmcard, vcov. = vcovHC)

summary(lm_nbr_genre_afmcard)$adj.r.squared

```

Globalement l'ajout d'interaction entre l'age et le stream ne donne rien de significatif, hormis pour les 46 - 55 ans dans la population matché, fait difficilement interprétable. 

# Effet du streaming sur l'intensité des pratiques d'écoute


## tableau croisé simple

Commeçont par un simple croisement entre fréquence d'écoute et streaming.

**Avant matching**

```{r}

PC18_to_m_survey %>%
  tbl_svysummary(
    include = c("stream_spe", "music_12m"), #L'ensemble des variables que l'on veut dans le tableau
    label = list(stream_spe ~ "Ecoute de la musique sur une plate forme de streaming"),
    by = music_12m, #La variale avec laquelle on croise les données qui ira en colonne
    missing = "ifany",
    statistic = list(all_categorical() ~ "{p} %"),
    digits = list(all_categorical() ~ c(1,0))
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "svy.chisq.test") %>%
  modify_footnote(update = everything() ~ NA) %>%
  as_gt() %>%
  tab_source_note(source_note = html("Source : Enquête Pratique culturelles des français 2018. Données pondérées pour les pourcentages.
                                     <br> Champ : Français agés de plus de 15 et plus.
                                     <br>Lecture : ")) %>%
  tab_header(title = "Ecoute de musique sur au moins une plateforme de streaming par fréquence d'écoute de musique") %>%
  opt_table_font(font = "Times New Roman") %>%
  tab_options(table_body.hlines.color = "black", source_notes.border.bottom.color = "black", table_body.border.bottom.color = "black",
              table_body.border.top.color = "black", row_group.border.top.color = "black", row_group.border.bottom.color = "black",
              heading.border.bottom.color = "black", column_labels.border.top.color = "black",  table.border.top.color = "black",
              table.border.bottom.color = "black", column_labels.border.bottom.color = "black")

```

**Après matching**

```{r}
PC18_m_survey %>%
  tbl_svysummary(
    include = c("stream_spe", "music_12m"), #L'ensemble des variables que l'on veut dans le tableau
    label = list(stream_spe ~ "Ecoute de la musique sur une plate forme de streaming"),
    by = music_12m, #La variale avec laquelle on croise les données qui ira en colonne
    missing = "ifany",
    statistic = list(all_categorical() ~ "{p} %"),
    digits = list(all_categorical() ~ c(1,0))
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "svy.chisq.test") %>%
  modify_footnote(update = everything() ~ NA) %>%
  as_gt() %>%
  tab_source_note(source_note = html("Source : Enquête Pratique culturelles des français 2018. Données pondérées pour les pourcentages.
                                     <br> Champ : Français agés de plus de 15 et plus.
                                     <br>Lecture : ")) %>%
  tab_header(title = "Ecoute de musique sur au moins une plateforme de streaming par fréquence d'écoute de musique") %>%
  opt_table_font(font = "Times New Roman") %>%
  tab_options(table_body.hlines.color = "black", source_notes.border.bottom.color = "black", table_body.border.bottom.color = "black",
              table_body.border.top.color = "black", row_group.border.top.color = "black", row_group.border.bottom.color = "black",
              heading.border.bottom.color = "black", column_labels.border.top.color = "black",  table.border.top.color = "black",
              table.border.bottom.color = "black", column_labels.border.bottom.color = "black")

```

## Regression logistique sans covariable

On peut utliser une regression pour modéliser la probabilité d'écouter de la musique tous les jours par la pratique du streaming

```{r}
formula_music_TLJ <- as.formula("music_TLJ ~ stream_spe")

glm_music_TLJ <- glm(formula_music_TLJ, PC18_to_m, weights = POND, family = "binomial")

coeftest(glm_music_TLJ, vcov. = vcovHC)

```

**Après matching**

```{r}
formula_music_TLJ <- as.formula("music_TLJ ~ stream_spe")

glm_music_TLJ <- glm(formula_music_TLJ, PC18_m, weights = POND_m, family = "binomial")

coeftest(glm_music_TLJ, vcov. = vcovHC)

```


**Après matching cardinality**

```{r}
formula_music_TLJ <- as.formula("music_TLJ ~ stream_spe")

glm_music_TLJ <- glm(formula_music_TLJ, PC18_m_card, family = "binomial")

coeftest(glm_music_TLJ, vcov. = vcovHC)

```

## Regression logistique avec covariables

Il est sans doute plus interessant d'ajouter les covariables, mais c'est un peu plus compliqué d'estimer les erreurs standars dans la population matché. 

```{r}
formula_music_TLJ <- as.formula(paste("music_TLJ ~ stream_spe", covar_formula, sep = " + "))

glm_music_TLJ <- glm(formula_music_TLJ, PC18_to_m, weights = POND, family = "binomial")

coeftest(glm_music_TLJ, vcov. = vcovHC)

```

```{r}

glm_music_TLJ <- glm(formula_music_TLJ, PC18_m, weights = POND_m, family = quasibinomial(link = "logit"))

est_fun <- function(PC18_to_m_boot, i) {
  
  res_match_1to1_re5max_cali_boot <- matchit(model_matching
                                  , data = PC18_to_m_boot[i,], 
                                  method = "nearest", distance = "glm", replace = T, reuse.max = 5,
                                  ratio = 1, caliper = c("AGE" = 2), std.caliper = F, discard = "treated")

  res_match_1to1_re5max_cali_boot <- add_s.weights(res_match_1to1_re5max_cali_boot, s.weights = "POND", data = PC18_to_m_boot)

  PC18_m_boot <- match.data(res_match_1to1_re5max_cali_boot, weights = "POND_m")
  
  glm_music_TLJ_boot <- glm(formula_music_TLJ, PC18_m_boot, weights = POND_m, family = quasibinomial(link = "logit"))
  
  PC18_m_boot$stream_spe <- 0  
  P0 <- weighted.mean(predict(glm_music_TLJ, PC18_m_boot, type = "response"),
                      w = PC18_m_boot$POND_m)
  Odds0 <- P0 / (1 - P0)
  
  PC18_m_boot$stream_spe <- 1
  P1 <- weighted.mean(predict(glm_music_TLJ, PC18_m_boot, type = "response"),
                      w = PC18_m_boot$POND_m)
  Odds1 <- P1 / (1 - P1)

  #Return marginal odds ratio
  
  print(Odds1 / Odds0)
  return(Odds1 / Odds0)
}

boot_est <- boot(PC18_to_m, est_fun, R = 4999)
boot_est
boot.ci(boot_est, type = "bca")
```

