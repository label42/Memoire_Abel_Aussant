---
title: "Analyse choix de variables"
author: "Abel AUSSANT"
date: "04/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)

pacman::p_load(tidyverse, questionr, gtsummary, gt, survey)

d <- read.csv("C:/Users/abela/Desktop/Espace de travail Sociologie/EHESS/M2 QESS/Mémoire M2/Données officielles Quetelet/PC2018/Csv/pc18_quetelet_octobre2021.csv",sep=";")

source("../recodage_matching.R")

# il manque 4 pondération...
d_survey <- subset(d, !is.na(d$POND))

#pour que la pop total soit égale au nombre de ligne dans la base (on divise la pondération par la somme de toutes les pondération divisé par le nombre d'individus)
d_survey$POND <- d_survey$POND/5629.778

print(sum(d_survey$POND))

d_survey <- survey::svydesign(id = ~IDENT18, data = d_survey, weights = d_survey$POND)

d_survey <- subset(d_survey, music_12m != "Jamais")

theme_gtsummary_language("fr", decimal.mark = ",", big.mark = " ")
```

## VITENCOUPLE = le fait de vivre en couple 

```{r VITENCOUPLE}



tab1 <- d_survey %>%
  tbl_svysummary(
    include = c("stream_spe", "VITENCOUPLE_r"), #L'ensemble des variables que l'on veut dans le tableau
    label = list(stream_spe ~ "Ecoute de la musique sur une plate forme de streaming spécialisée"),
    by = VITENCOUPLE_r, #La variale avec laquelle on croise les données qui ira en colonne
    missing = "ifany",
    statistic = list(all_categorical() ~ "{p} % N = {n_unweighted}"),
    digits = list(all_categorical() ~ c(1,0))
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "svy.chisq.test") %>%
  modify_footnote(update = everything() ~ NA) %>%
  as_gt()

tab1_t <- tab1 %>%
  tab_source_note(source_note = html("Source : 
                                     <br> Champ : 
                                     <br>Lecture : ")) %>%
  tab_header(title = "Ecoute de musique sur au moins une plateforme de streaming par vit en couple") %>%
  opt_table_font(font = "Times New Roman") %>%
  tab_options(table_body.hlines.color = "black", source_notes.border.bottom.color = "black", table_body.border.bottom.color = "black",
              table_body.border.top.color = "black", row_group.border.top.color = "black", row_group.border.bottom.color = "black",
              heading.border.bottom.color = "black", column_labels.border.top.color = "black",  table.border.top.color = "black",
              table.border.bottom.color = "black", column_labels.border.bottom.color = "black")

tab1_t

tab1 <- d_survey %>%
  tbl_svysummary(
    include = c("nbr_genre_music", "VITENCOUPLE_r"), #L'ensemble des variables que l'on veut dans le tableau
    label = list(nbr_genre_music ~ "Nombre de styles musicaux écoutés"),
    by = VITENCOUPLE_r, #La variale avec laquelle on croise les données qui ira en colonne
    missing = "ifany",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(all_categorical() ~ c(1,0))
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "svy.chisq.test") %>%
  modify_footnote(update = everything() ~ NA) %>%
  as_gt()

tab1_t <- tab1 %>%
  tab_source_note(source_note = html("Source : 
                                     <br> Champ : 
                                     <br>Lecture : ")) %>%
  tab_header(title = "Nombre de styles écoutés par vit en couple") %>%
  opt_table_font(font = "Times New Roman") %>%
  tab_options(table_body.hlines.color = "black", source_notes.border.bottom.color = "black", table_body.border.bottom.color = "black",
              table_body.border.top.color = "black", row_group.border.top.color = "black", row_group.border.bottom.color = "black",
              heading.border.bottom.color = "black", column_labels.border.top.color = "black",  table.border.top.color = "black",
              table.border.bottom.color = "black", column_labels.border.bottom.color = "black")

tab1_t


d_tmp <- subset(d, !is.na(d$VITENCOUPLE_r) & !is.na(d$E83))

cor_nbr_genre <- cor(d_tmp$nbr_genre_music, as.numeric(d_tmp$VITENCOUPLE_r))
cor_stream <- cor(d_tmp$E83, as.numeric(d_tmp$VITENCOUPLE_r))

lm_nbr_genre <- summary(lm(nbr_genre_music ~ VITENCOUPLE_r + E83, data = d_tmp))

```

Coef. de Correlation entre nbr_genre_music et VITENCOUPLE_r = `r cor_nbr_genre`

Coef. de Correlation entre stream et VITENCOUPLE_r = `r cor_stream`

R² de nbr_genre_music ~ VITENCOUPLE_r + E83 = `r lm_nbr_genre$r.squared`
Association faible avec le nombre de styles écoutés. A rejeter.

## Voyage à l'étrangé au cours des 12 mois pour vacances

```{r ETRANGER_VAC}



tab1 <- d_survey %>%
  tbl_svysummary(
    include = c("stream_spe", "voyage_etranger"), #L'ensemble des variables que l'on veut dans le tableau
    label = list(stream_spe ~ "Ecoute de la musique sur une plate forme de streaming spécialisée"),
    by = voyage_etranger, #La variale avec laquelle on croise les données qui ira en colonne
    missing = "ifany",
    statistic = list(all_categorical() ~ "{p} % N = {n_unweighted}"),
    digits = list(all_categorical() ~ c(1,0))
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "svy.chisq.test") %>%
  modify_footnote(update = everything() ~ NA) %>%
  as_gt()

tab1_t <- tab1 %>%
  tab_source_note(source_note = html("Source : 
                                     <br> Champ : 
                                     <br>Lecture : ")) %>%
  tab_header(title = "Ecoute de musique sur au moins une plateforme de streaming par Voyage à l'étrangé au cours des 12 mois pour vacances") %>%
  opt_table_font(font = "Times New Roman") %>%
  tab_options(table_body.hlines.color = "black", source_notes.border.bottom.color = "black", table_body.border.bottom.color = "black",
              table_body.border.top.color = "black", row_group.border.top.color = "black", row_group.border.bottom.color = "black",
              heading.border.bottom.color = "black", column_labels.border.top.color = "black",  table.border.top.color = "black",
              table.border.bottom.color = "black", column_labels.border.bottom.color = "black")

tab1_t

tab1 <- d_survey %>%
  tbl_svysummary(
    include = c("nbr_genre_music", "voyage_etranger"), #L'ensemble des variables que l'on veut dans le tableau
    label = list(nbr_genre_music ~ "Nombre de styles musicaux écoutés"),
    by = voyage_etranger, #La variale avec laquelle on croise les données qui ira en colonne
    missing = "ifany",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(all_categorical() ~ c(1,0))
  ) %>%
  add_overall() %>%
  add_p(test = everything() ~ "svy.chisq.test") %>%
  modify_footnote(update = everything() ~ NA) %>%
  as_gt()

tab1_t <- tab1 %>%
  tab_source_note(source_note = html("Source : 
                                     <br> Champ : 
                                     <br>Lecture : ")) %>%
  tab_header(title = "Nombre de styles écoutés par voyage à l'étrangé au cours des 12 mois pour vacances") %>%
  opt_table_font(font = "Times New Roman") %>%
  tab_options(table_body.hlines.color = "black", source_notes.border.bottom.color = "black", table_body.border.bottom.color = "black",
              table_body.border.top.color = "black", row_group.border.top.color = "black", row_group.border.bottom.color = "black",
              heading.border.bottom.color = "black", column_labels.border.top.color = "black",  table.border.top.color = "black",
              table.border.bottom.color = "black", column_labels.border.bottom.color = "black")

tab1_t

d_tmp <- subset(d, !is.na(d$voyage_etranger) & !is.na(d$E83))

cor_nbr_genre <- cor(d_tmp$nbr_genre_music, d_tmp$voyage_etranger)
cor_stream <- cor(d_tmp$E83, d_tmp$voyage_etranger)

lm_nbr_genre <- summary(lm(nbr_genre_music ~ voyage_etranger + E83, data = d_tmp))

```

Coef. de Correlation entre nbr_genre_music et voyage_etranger = `r cor_nbr_genre`

Coef. de Correlation entre stream et voyage_etranger = `r cor_stream`

R² de nbr_genre_music ~ voyage_etranger + E83 = `r lm_nbr_genre$r.squared`

Associations avec les deux variables, à considérer.


